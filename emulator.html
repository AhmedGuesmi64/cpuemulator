<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CP Emulator — Runtime</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="css/theme.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material-darker.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.css">
</head>
<!-- this html page took too damn long to make I don't even know why -->
<body>
  <div class="app">
    <!-- Primary nav -->
    <nav class="primary-nav">
      <div class="nav-left">
        <div class="brand">CP</div>
        <button class="nav-button" onclick="location.href='index.html'">Home</button>
        <button class="nav-button" onclick="location.href='emulator.html'">Emulator</button>
        <button class="nav-button" onclick="location.href='docs/README.html'">Docs</button>
      </div>
      <div class="nav-right">
        <button class="nav-button ghost" id="nav-back">Back</button>
        <button class="nav-button ghost" id="nav-forward">Forward</button>
        <button class="nav-button ghost" id="theme-toggle">Light Mode</button>
      </div>
    </nav>

    <!-- Secondary nav -->
    <nav class="secondary-nav">
      <div class="nav-group">
        <button class="nav-button">Editors ▾</button>
        <div class="nav-dropdown">
          <a class="dropdown-item" href="#" onclick="assemble(); return false;">Assemble</a>
          <a class="dropdown-item" href="#" onclick="loadMachineCode(); return false;">Load Machine Code</a>
          <a class="dropdown-item" href="#" onclick="clearSource(); return false;">Clear Editors</a>
          <a class="dropdown-item" href="#" onclick="document.getElementById('file-input').click(); return false;">Import .asm/.hex</a>
        </div>
      </div>
      <div class="nav-group">
        <button class="nav-button">Memory ▾</button>
        <div class="nav-dropdown">
          <a class="dropdown-item" id="nav-mem-unified" href="#" onclick="setMemoryView('unified'); return false;">Unified View</a>
          <a class="dropdown-item" id="nav-mem-split" href="#" onclick="setMemoryView('split'); return false;">Split View</a>
          <a class="dropdown-item" href="#" onclick="restart(); return false;">Restart (PC=0)</a>
          <a class="dropdown-item" href="#" onclick="reset(); return false;">Reset All</a>
        </div>
      </div>
      <div class="nav-group">
        <button class="nav-button">Run ▾</button>
        <div class="nav-dropdown">
          <a class="dropdown-item" href="#" onclick="step(); return false;">Step</a>
          <a class="dropdown-item" href="#" onclick="run(); return false;">Run</a>
          <a class="dropdown-item" href="#" onclick="animateExec(); return false;">Animate</a>
          <a class="dropdown-item" href="#" onclick="stop(); return false;">Stop</a>
        </div>
      </div>
      <div class="nav-group">
        <button class="nav-button">Project ▾</button>
        <div class="nav-dropdown">
          <a class="dropdown-item" href="#" onclick="exportProject(); return false;">Export Project</a>
          <a class="dropdown-item" href="#" onclick="document.getElementById('project-file-input').click(); return false;">Import Project</a>
        </div>
      </div>
      <div class="nav-group">
        <button class="nav-button">Samples ▾</button>
        <div class="nav-dropdown">
          <a class="dropdown-item" href="#" onclick="loadSampleTest('add_two','asm'); return false;">Add Two (ASM)</a>
          <a class="dropdown-item" href="#" onclick="loadSampleTest('add_two','hex'); return false;">Add Two (HEX)</a>
          <a class="dropdown-item" href="#" onclick="loadSampleTest('store_and_mix','asm'); return false;">Store & Mix (ASM)</a>
          <a class="dropdown-item" href="#" onclick="loadSampleTest('store_and_mix','hex'); return false;">Store & Mix (HEX)</a>
          <a class="dropdown-item" href="#" onclick="loadSampleTest('loop_sum','asm'); return false;">Loop Sum (ASM)</a>
          <a class="dropdown-item" href="#" onclick="loadSampleTest('loop_sum','hex'); return false;">Loop Sum (HEX)</a>
          <div class="dropdown-separator"></div>
          <a class="dropdown-item" href="#" onclick="loadExercise22(); return false;">Exercise 22</a>
          <a class="dropdown-item" href="#" onclick="loadExercise23(); return false;">Exercise 23</a>
        </div>
        </div>
      </nav>
      
    <div class="header">
      <div class="brand">CP</div>
      <div>
        <div class="title">CP Emulator — Runtime</div>
        <div class="subtitle">Step / Run / Animate a tiny CPU</div>
      </div>
    </div>

    <div class="editor row">
      <!-- LEFT: Controls -->
      <div class="pane">
        <div class="top-controls card">
          <div class="panel-block">
            <div class="panel-block__header">
          <div>
                <strong>Machine Code (hex)</strong>
                <div class="panel-block__sub">Paste bytes or load a demo, then push to program memory.</div>
              </div>
            </div>
            <textarea id="machine-in" class="input" rows="6" placeholder="00 00 01 31 B4 02 32 BB 43 33 C0"></textarea>
            <div class="button-row">
              <button class="btn secondary" onclick="loadMachineCode()">Load → Program Memory</button>
          <button class="btn secondary" onclick="clearHex()">Clear HEX</button>
            </div>
            <input id="file-input" type="file" accept=".asm,.s,.txt,.hex" style="display:none" />
            <button class="btn secondary" style="margin-top:8px" onclick="document.getElementById('file-input').click()">Import .asm / .hex</button>
          </div>

          <div class="panel-block">
            <div class="panel-block__header">
              <div>
                <strong>Assembler (optional)</strong>
                <div class="panel-block__sub">Write mnemonics; assemble to update program memory and hex view.</div>
            </div>
          </div>
            <textarea id="assembler-in" class="input" rows="6" placeholder="LD [30], r0&#10;LD [31], r1&#10;ADD r3, r1, r0"></textarea>
            <div class="button-row">
              <button class="btn" onclick="assemble()">Assemble → Program Memory</button>
              <button class="btn secondary" onclick="clearSource()">Clear</button>
          <button class="btn secondary" onclick="clearAsm()">Clear ASM</button>
            </div>
            <!-- Drop is now wired directly onto editors -->
          </div>
        </div>

        <div class="sep"></div>

      </div>

      <!-- MIDDLE: Unified Memory -->
        <div class="pane card emulator-pane">
          <div class="memory-section__header" style="margin-bottom:12px; align-items:center;">
            <div>
              <strong>Memory View</strong>
              <div class="memory-section__sub">Switch between unified (shared) and split (program/data)</div>
            </div>
            <div class="mode-toggle" style="gap:6px;">
              <button id="mem-view-unified" class="active">Unified</button>
              <button id="mem-view-split">Split</button>
            </div>
          </div>
          <div id="unified-wrapper">
            <div class="table-wrapper">
              <table id="unified-mem-table" class="table"></table>
            </div>
          </div>
          <div id="split-wrapper" class="hidden">
            <div class="memory-grid">
              <div class="memory-section">
                <div class="memory-section__header">
                  <div>
            <strong>Program Memory</strong>
                    <div class="memory-section__sub">Instructions &amp; disassembly</div>
                  </div>
                  <span class="badge">256 bytes</span>
                </div>
                <div class="table-wrapper">
                  <table id="prog-mem-table" class="table"></table>
                </div>
          </div>
              <div class="memory-section">
                <div class="memory-section__header">
                  <div>
            <strong>Data Memory</strong>
                    <div class="memory-section__sub">Live RAM contents</div>
                  </div>
                  <span class="badge">256 bytes</span>
                </div>
                <div class="table-wrapper">
                  <table id="data-mem-table" class="table"></table>
                </div>
              </div>
            </div>
          </div>
        </div>

      <!-- RIGHT: Registers & controls -->
      <div class="pane sidebar-pane">
        <div class="card status-card">
          <div class="card-heading">
            <strong>CPU Status</strong>
            <span id="run-state" class="state-pill state-pill--idle">Ready</span>
          </div>
          <div class="status-grid">
            <div class="status-chip">
              <span class="status-label">PC</span>
              <span class="status-value" id="pc">00</span>
            </div>
            <div class="status-chip">
              <span class="status-label">Next</span>
              <span class="status-value" id="next-pc">--</span>
            </div>
            <div class="status-chip">
              <span class="status-label">Flags</span>
              <span class="status-value" id="flags">Z:0 C:0</span>
            </div>
          </div>
          <div id="regs" class="reg-grid">
            <div class="reg-box"><strong>r0</strong><div id="reg0" class="reg-val">00</div></div>
            <div class="reg-box"><strong>r1</strong><div id="reg1" class="reg-val">00</div></div>
            <div class="reg-box"><strong>r2</strong><div id="reg2" class="reg-val">00</div></div>
            <div class="reg-box"><strong>r3</strong><div id="reg3" class="reg-val">00</div></div>
          </div>
        </div>

        <div class="card control-card">
          <div class="button-grid">
            <button class="btn" onclick="step()">Step</button>
            <button class="btn" onclick="run()">Run</button>
            <button class="btn" onclick="animateExec()">Animate</button>
            <button class="btn secondary" onclick="restart()">Restart</button>
            <button class="btn secondary" onclick="reset()">Reset All</button>
            <button class="btn secondary" onclick="stop()">Stop</button>
          </div>
          <div class="delay-row">
            <label>Anim delay (ms)</label>
            <input id="anim-delay" type="number" class="input" value="400" />
          </div>
        </div>

        <div class="card trace-card">
          <div class="trace-header">
          <strong>Execution Trace</strong>
            <div class="mode-toggle">
              <button id="trace-mode-asm" class="active" onclick="setTraceMode('asm')">Assembly</button>
              <button id="trace-mode-hex" onclick="setTraceMode('hex')">Machine</button>
              <button id="trace-export-btn" class="btn secondary" style="margin-left:8px" onclick="exportTrace()">Export Trace</button>
            </div>
          </div>
          <div id="trace" class="trace-body"></div>
        </div>

        <div class="card project-card">
          <div class="card-heading">
            <strong>Project I/O</strong>
            <span class="note">Save/restore ASM, HEX, memory, and registers</span>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
            <button class="btn secondary" onclick="exportProject()">Export Project</button>
            <button class="btn secondary" onclick="document.getElementById('project-file-input').click()">Import Project</button>
            <input id="project-file-input" type="file" accept=".json,.cpuproj.json" style="display:none" onchange="handleProjectImport(event)" />
          </div>
        </div>

        <div class="card legend-card">
          <div class="card-heading">
            <strong>Legend</strong>
            <button class="btn secondary" id="legend-toggle-btn" onclick="toggleLegend()">Show Legend</button>
          </div>
          <div class="legend-list collapsed" id="legend-list">
            <span style="background:rgba(0,0,255,0.22);padding:2px 6px;">Current (Blue)</span> – instruction being executed<br>
            <span style="background:rgba(255,0,0,0.18);padding:2px 6px;">Previous (Red)</span> – instruction just executed<br>
            <span style="background:rgba(0,255,0,0.18);padding:2px 6px;">Next (Green)</span> – instruction that will execute next<br>
            <span style="background:rgba(61,223,230,0.20);padding:2px 6px;">Teal</span> – memory write<br>
            <span style="background:rgba(24,180,162,0.18);padding:2px 6px;">Greenish</span> – memory read<br>
            <span style="background:rgba(61,130,255,0.25);padding:2px 6px;">Blue flash</span> – register update
          </div>
          <div style="margin-top:10px; text-align:right;">
            <button class="btn secondary" id="highlight-toggle-btn">Hide prev/next highlight</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="js/navigationMenuScript.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/simple/simple.min.js"></script>
  <script src="js/themeToggle.js"></script>
  <script src="js/coreState.js"></script>
  <script src="js/assemblerModule.js"></script>
  <script src="js/executionModule.js"></script>
  <script src="js/uiModule.js"></script>
  <script src="js/editorEnhance.js"></script>
  <script src="js/projectBundle.js"></script>
  <script src="js/appBindings.js"></script>
</body>
</html>
